name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ZIG_VERSION: 0.15.2

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

  check-baselines:
    name: Check Baselines
    runs-on: ubuntu-latest
    outputs:
      has-baselines: ${{ steps.check.outputs.has-baselines }}
    steps:
    - uses: actions/checkout@v4

    - name: Check if CI baselines exist
      id: check
      run: |
        if [ -d "bench/baselines/ci" ] && [ -n "$(ls -A bench/baselines/ci/*.json 2>/dev/null || true)" ]; then
          echo "has-baselines=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Found CI baselines"
          ls bench/baselines/ci/
        else
          echo "has-baselines=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No CI baselines found - benchmark gate will be skipped"
        fi

  benchmark-gate:
    name: Benchmark Gate
    runs-on: ubuntu-latest
    needs: [test, check-baselines]
    if: needs.check-baselines.outputs.has-baselines == 'true'
    steps:
    - uses: actions/checkout@v4

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Validate existing baselines
      run: |
        ./scripts/manage_baselines.sh validate bench/baselines/ci

    - name: Build benchmark harness
      run: |
        ./scripts/manage_baselines.sh build

    - name: Run benchmark gate - micro suite
      run: |
        ./scripts/manage_baselines.sh gate bench/baselines/ci micro

    - name: Run benchmark gate - hardening suite
      run: |
        ./scripts/manage_baselines.sh gate bench/baselines/ci hardening || true  # Don't fail CI for hardening yet

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: benchmark-results-${{ github.run_number }}
        path: bench/results/
        retention-days: 30

  establish-baselines:
    name: Establish Baselines
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.check-baselines.outputs.has-baselines == 'false'
    needs: [test, check-baselines]
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Generate initial baselines
      run: |
        ./scripts/manage_baselines.sh generate micro 5 bench/baselines/ci

    - name: Commit and push baselines
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bench/baselines/ci/
        if git diff --staged --quiet; then
          echo "No baseline changes to commit"
        else
          git commit -m "ü§ñ Establish initial CI baselines [skip ci]"
          git push
        fi

  update-baselines:
    name: Update Baselines
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Generate updated baselines
      run: |
        # Only update if this is a manual trigger or if there are significant changes
        if [[ "${{ github.event.head_commit.message }}" =~ \[update-baselines\] ]]; then
          ./scripts/manage_baselines.sh generate micro 5 bench/baselines/ci
        else
          echo "Skipping baseline update - not requested in commit message"
          echo "To trigger update, include '[update-baselines]' in commit message"
        fi

    - name: Commit and push baselines
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bench/baselines/ci/
        if git diff --staged --quiet; then
          echo "No baseline changes to commit"
        else
          git commit -m "ü§ñ Update CI baselines [skip ci]"
          git push
        fi