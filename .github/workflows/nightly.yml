name: Nightly

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  ZIG_VERSION: 0.15.2

jobs:
  hardening:
    name: Hardening Suite
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build benchmark harness
      run: |
        zig build

    - name: Run hardening suite
      run: |
        ./zig-out/bin/bench run --suite hardening --repeats 3

    - name: Upload hardening results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: hardening-results-${{ github.run_number }}
        path: bench/results/
        retention-days: 90

    - name: Check hardening test passes
      run: |
        # Ensure all hardening tests passed (errors_total should be 0)
        for file in bench/results/bench/hardening/*.json; do
          if [ -f "$file" ]; then
            errors=$(jq '.errors_total // 0' "$file")
            if [ "$errors" -ne 0 ]; then
              echo "FAIL: Hardening test failed with $errors errors in $file"
              exit 1
            fi
          fi
        done
        echo "PASS: All hardening tests completed successfully"

  macrobenches:
    name: Macrobench Suite
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build benchmark harness
      run: |
        zig build

    - name: Run macrobench suite
      run: |
        ./zig-out/bin/bench run --suite macro --repeats 3

    - name: Upload macrobench results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: macrobench-results-${{ github.run_number }}
        path: bench/results/
        retention-days: 90

    - name: Check macrobench passes
      run: |
        # Ensure all macrobenches completed successfully
        # Note: task_queue_clamins uses errors_total to track contention (expected)
        for file in bench/results/bench/macro/*.json; do
          if [ -f "$file" ]; then
            # Verify JSON is valid and has required fields
            if ! jq -e '.bench_name and .results' "$file" > /dev/null; then
              echo "FAIL: Invalid benchmark output in $file"
              exit 1
            fi
            echo "OK: $(jq -r '.bench_name' "$file") completed"
          fi
        done
        echo "PASS: All macrobenches completed successfully"

  refresh_baselines:
    name: Refresh Baselines
    runs-on: ubuntu-latest
    needs: [hardening, macrobenches]
    if: github.event_name == 'schedule'
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build benchmark harness
      run: |
        zig build

    - name: Capture macrobench baselines
      run: |
        ./zig-out/bin/bench run --suite macro --repeats 3 --output bench/baselines/ci

    - name: Capture hardening baselines
      run: |
        ./zig-out/bin/bench run --suite hardening --repeats 3 --output bench/baselines/ci

    - name: Commit refreshed baselines
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add bench/baselines/ci/
        git diff --staged --quiet || git commit -m "$(cat <<'EOF'
        ci(nightly): Refresh baselines

        Automated baseline refresh from nightly CI run.

        - Macrobench suite baselines updated
        - Hardening suite baselines updated

        ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        )"
        git push
