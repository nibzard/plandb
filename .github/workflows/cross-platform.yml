name: Cross-Platform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

env:
  ZIG_VERSION: 0.15.2

jobs:
  # Linux x86_64 (baseline - already covered by ci.yml)
  test-linux:
    name: Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run quick microbenchmark smoke test
      run: |
        # Quick smoke test to ensure benchmarks compile and run
        ./zig-out/bin/bench run --filter "pager_open_close" --repeats 1 || true

  # macOS x86_64
  test-macos-x64:
    name: macOS (x86_64)
    runs-on: macos-13 # Intel-based runner
    steps:
    - uses: actions/checkout@v6

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        if ! command -v jq &> /dev/null; then
          brew install jq
        fi

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run quick microbenchmark smoke test
      run: |
        ./zig-out/bin/bench run --filter "pager_open_close" --repeats 1 || true

  # macOS ARM64 (Apple Silicon)
  test-macos-arm64:
    name: macOS (ARM64)
    runs-on: macos-14 # Apple Silicon runner
    steps:
    - uses: actions/checkout@v6

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        if ! command -v jq &> /dev/null; then
          brew install jq
        fi

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run quick microbenchmark smoke test
      run: |
        ./zig-out/bin/bench run --filter "pager_open_close" --repeats 1 || true

  # Windows x86_64
  test-windows-x64:
    name: Windows (x86_64)
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
    - uses: actions/checkout@v6

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install jq
      run: |
        # Use scoop to install jq on Windows
        iex "& {$(irm get.scoop.sh)} -RunAsTask" -ErrorAction SilentlyContinue
        if ($LASTEXITCODE -ne 0) {
          # Fallback: download jq binary
          Invoke-WebRequest -Uri "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe" -OutFile "jq.exe"
          $env:Path += ";$PWD"
        } else {
          scoop install jq
        }

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run quick microbenchmark smoke test
      run: |
        .\zig-out\bin\bench.exe run --filter "pager_open_close" --repeats 1; exit 0

  # Linux ARM64 (using ARM64 runners for native execution)
  test-linux-arm64:
    name: Linux (ARM64)
    runs-on: ubuntu-24.04-arm64
    steps:
    - uses: actions/checkout@v6

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run quick microbenchmark smoke test
      run: |
        ./zig-out/bin/bench run --filter "pager_open_close" --repeats 1 || true

  # Cross-platform test summary
  summary:
    name: Cross-Platform Summary
    needs: [test-linux, test-macos-x64, test-macos-arm64, test-windows-x64, test-linux-arm64]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Check all platform tests
      run: |
        echo "Cross-platform CI complete!"
        echo "=========================="
        echo "Linux (x86_64): ${{ needs.test-linux.result }}"
        echo "macOS (x86_64): ${{ needs.test-macos-x64.result }}"
        echo "macOS (ARM64): ${{ needs.test-macos-arm64.result }}"
        echo "Windows (x86_64): ${{ needs.test-windows-x64.result }}"
        echo "Linux (ARM64): ${{ needs.test-linux-arm64.result }}"
        echo "=========================="

        if [ "${{ needs.test-linux.result }}" != "success" ] || \
           [ "${{ needs.test-macos-x64.result }}" != "success" ] || \
           [ "${{ needs.test-macos-arm64.result }}" != "success" ] || \
           [ "${{ needs.test-windows-x64.result }}" != "success" ] || \
           [ "${{ needs.test-linux-arm64.result }}" != "success" ]; then
          echo "FAIL: One or more platform tests failed"
          exit 1
        fi

        echo "SUCCESS: All platform tests passed!"
